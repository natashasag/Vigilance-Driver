<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vigilance Driver - Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
    }

    /* Header */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #222;
      padding: 16px 24px;
    }
    header .logo { display: flex; align-items: center; gap: 12px; }
    header .logo h1 { font-size: 20px; color: #fff; }
    header .logo p { font-size: 12px; color: #888; }
    header .actions { display: flex; align-items: center; gap: 16px; }
    header .status { color: #22c55e; font-size: 14px; }
    .btn-privacy {
      display: flex; align-items: center; gap: 8px;
      background: #1a1a1a; border: 1px solid #333;
      color: #e0e0e0; padding: 8px 16px;
      border-radius: 999px; font-size: 14px; cursor: pointer;
    }
    .btn-privacy:hover { background: #252525; }
    .btn-signout {
      background: none; border: none; color: #888;
      font-size: 14px; cursor: pointer;
    }
    .btn-signout:hover { color: #fff; }

    /* Grid Layout */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      padding: 24px;
    }
    @media (max-width: 1024px) {
      .dashboard-grid { grid-template-columns: 1fr; }
    }

    /* Glass Card */
    .glass-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid #222;
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }

    /* Video Feed */
    .video-container {
      position: relative;
      aspect-ratio: 16/9;
      background: #111;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border-radius: 12px 12px 0 0;
    }
    .video-container video, .video-container canvas {
      width: 100%; height: 100%; object-fit: cover;
    }
    .video-container canvas {
      position: absolute; inset: 0; pointer-events: none;
    }
    .video-placeholder {
      position: absolute; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      color: #888;
    }
    .video-placeholder span { font-size: 48px; margin-bottom: 12px; }

    /* Start/Stop Button */
    #toggleBtn {
      width: 100%;
      padding: 16px;
      font-size: 18px;
      font-weight: 700;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      transition: all 0.3s;
      background: #22c55e;
      color: #fff;
      animation: pulseGreen 2s infinite;
    }
    #toggleBtn.running {
      background: #ef4444;
      animation: none;
    }
    #toggleBtn:hover { filter: brightness(1.1); }
    @keyframes pulseGreen {
      0%, 100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.4); }
      50% { box-shadow: 0 0 20px 6px rgba(34,197,94,0.2); }
    }

    /* Session Log */
    .session-log { padding: 24px; }
    .session-log h3 { font-size: 16px; font-weight: 700; margin-bottom: 12px; }
    .log-list { max-height: 160px; overflow-y: auto; }
    .log-item { display: flex; gap: 8px; font-size: 14px; padding: 4px 0; }
    .log-time { color: #888; }
    .log-danger { color: #ef4444; }
    .log-warning { color: #f59e0b; }

    /* Stats Cards */
    .stats-section { display: flex; flex-direction: column; gap: 24px; }
    .stat-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid #222;
      border-radius: 12px;
      padding: 24px;
    }
    .stat-card h3 { font-size: 14px; font-weight: 600; margin-bottom: 8px; }
    .stat-value {
      text-align: center; font-size: 36px;
      font-weight: 700; color: #22c55e;
      font-family: 'Courier New', monospace;
    }
    .stat-sub { text-align: center; font-size: 12px; color: #888; margin-top: 4px; }

    /* Progress Bar */
    .progress-bar {
      height: 8px; width: 100%; background: #222;
      border-radius: 999px; overflow: hidden; margin-top: 12px;
    }
    .progress-fill {
      height: 100%; border-radius: 999px;
      background: #22c55e; transition: width 0.3s;
    }
    .progress-fill.warning { background: #f59e0b; }
    .progress-fill.danger { background: #ef4444; }

    /* Status Banner */
    .status-banner {
      padding: 16px; border-radius: 8px;
      text-align: center; font-size: 18px; font-weight: 700;
    }
    .status-alert { background: #22c55e; color: #fff; }
    .status-warning { background: #f59e0b; color: #fff; }
    .status-danger { background: #ef4444; color: #fff; }

    /* Quick Stats Grid */
    .quick-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .mini-stat {
      background: rgba(255,255,255,0.03);
      border: 1px solid #222;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    .mini-stat .value { font-size: 24px; font-weight: 700; margin-top: 8px; }
    .mini-stat .label { font-size: 12px; color: #888; }

    /* Bottom Grid */
    .bottom-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      padding: 0 24px 24px;
    }
    @media (max-width: 1024px) {
      .bottom-grid { grid-template-columns: 1fr; }
    }

    /* Mode Toggle */
    .mode-toggle {
      display: flex; align-items: center; gap: 12px;
      border: 1px solid #333; border-radius: 12px;
      padding: 16px; cursor: pointer; transition: all 0.3s;
    }
    .mode-toggle.active {
      border-color: #22c55e;
      box-shadow: 0 0 12px rgba(34,197,94,0.15);
    }
    .mode-icon {
      width: 40px; height: 40px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      background: #1a1a1a; font-size: 18px;
    }
    .mode-toggle.active .mode-icon { background: #22c55e; }
    .mode-info { flex: 1; }
    .mode-info p { font-weight: 600; }
    .mode-info small { font-size: 12px; color: #888; }
    .toggle-switch {
      width: 44px; height: 24px; border-radius: 999px;
      background: #333; position: relative; transition: 0.3s;
    }
    .toggle-switch.active { background: #22c55e; }
    .toggle-knob {
      width: 20px; height: 20px; border-radius: 50%;
      background: #e0e0e0; position: absolute;
      top: 2px; left: 2px; transition: 0.3s;
    }
    .toggle-switch.active .toggle-knob { transform: translateX(20px); }

    /* Wellness */
    .wellness-box {
      background: #1a1a1a; border-radius: 8px; padding: 16px; margin-bottom: 16px;
    }
    .wellness-box p { font-weight: 600; }
    .wellness-box small { color: #888; }
    .wellness-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; text-align: center; }
    .wellness-stats .val { font-size: 24px; font-weight: 700; }
    .wellness-stats .lbl { font-size: 12px; color: #888; }

    /* How It Works */
    .how-section {
      border-top: 1px solid #222; padding: 32px 24px;
    }
    .how-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 32px;
    }
    @media (max-width: 768px) { .how-grid { grid-template-columns: 1fr; } }
    .how-grid code {
      display: block; background: #1a1a1a;
      padding: 8px 16px; border-radius: 8px;
      font-size: 14px; color: #888; margin-top: 8px;
    }
    .how-grid ul { list-style: none; padding: 0; }
    .how-grid li { font-size: 14px; color: #888; padding: 2px 0; }

    /* Footer */
    footer {
      border-top: 1px solid #222; padding: 32px 24px;
    }
    .footer-grid {
      display: grid; grid-template-columns: 1fr 1fr 1fr;
      gap: 32px; max-width: 1200px; margin: 0 auto;
    }
    @media (max-width: 768px) { .footer-grid { grid-template-columns: 1fr; } }
    .footer-grid h4 { font-weight: 700; margin-bottom: 12px; }
    .footer-grid ul { list-style: none; padding: 0; }
    .footer-grid li { font-size: 14px; color: #888; padding: 2px 0; }
    .footer-bottom {
      text-align: center; font-size: 14px; color: #888;
      margin-top: 32px; padding-top: 24px; border-top: 1px solid #222;
    }

    /* Explainability */
    .explain-section {
      border-top: 1px solid #222; margin-top: 16px; padding-top: 12px;
    }
    .explain-section h4 { font-size: 12px; font-weight: 600; color: #f59e0b; }
    .explain-section p { font-size: 12px; color: #888; margin-top: 4px; }
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <div class="logo">
      <span style="font-size:28px;">üëÅ</span>
      <div>
        <h1>Driver Drowsiness Detection</h1>
        <p>Real-time EAR &amp; Facial Landmark Monitoring</p>
      </div>
    </div>
    <div class="actions">
      <span class="status">üü¢ Online</span>
      <button class="btn-privacy" id="privacyBtn" onclick="togglePrivacy()">üõ° Privacy Mode üëÅ</button>
      <button class="btn-signout" onclick="signOut()">üö™ Sign Out</button>
    </div>
  </header>

  <!-- Main Dashboard Grid -->
  <div class="dashboard-grid">
    <!-- Left Column -->
    <div style="display:flex;flex-direction:column;gap:24px;">

      <!-- Video Feed -->
      <div class="glass-card">
        <div class="video-container">
          <video id="video" muted playsinline></video>
          <canvas id="canvas"></canvas>
          <div class="video-placeholder" id="placeholder">
            <span>üëÅ</span>
            <p id="placeholderText">Loading face detection models...</p>
          </div>
        </div>
      </div>

      <!-- Start/Stop Button (Moved Here) -->
      <button id="toggleBtn" onclick="toggleDetection()">üì∑ Start Detection</button>

      <!-- Session Log -->
      <div class="glass-card session-log">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <h3>üïê Session Log</h3>
          <span style="font-size:14px;color:#888;" id="logCount">0 events</span>
        </div>
        <div class="log-list" id="logList">
          <p style="text-align:center;color:#888;font-size:14px;">Start detection to see logs</p>
        </div>
      </div>
    </div>

    <!-- Right Column -->
    <div class="stats-section">

      <!-- Current Status -->
      <div class="stat-card">
        <h3>Current Status</h3>
        <div class="status-banner status-alert" id="statusBanner">Driver Alert</div>
      </div>

      <!-- EAR -->
      <div class="stat-card">
        <h3>Eye Aspect Ratio (EAR)</h3>
        <div class="stat-value" id="earValue">0.000</div>
        <p class="stat-sub" id="earStatus">Threshold: 0.25 | Eyes Open</p>
        <div class="progress-bar">
          <div class="progress-fill" id="earBar" style="width:0%"></div>
        </div>
      </div>

      <!-- Drowsiness Score -->
      <div class="stat-card">
        <h3>‚ö° Multi-Factor Drowsiness Score</h3>
        <div class="stat-value" id="drowsinessValue">0</div>
        <p class="stat-sub" id="fatigueLabel" style="font-weight:600;color:#22c55e;">Low Fatigue Level</p>
        <div class="progress-bar">
          <div class="progress-fill" id="drowsinessBar" style="width:0%"></div>
        </div>
        <div class="explain-section">
          <h4>‚ö† Why this score?</h4>
          <p id="explainText">‚Ä¢ Alertness levels are normal</p>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="quick-stats">
        <div class="mini-stat">
          <span>üåô</span>
          <div class="value" id="microSleeps">0</div>
          <div class="label">Micro-sleeps</div>
        </div>
        <div class="mini-stat">
          <span>üìà</span>
          <div class="value" id="blinkRate">0/min</div>
          <div class="label">Blink Rate</div>
        </div>
        <div class="mini-stat">
          <span>üëÅ</span>
          <div class="value" id="blinks">0</div>
          <div class="label">Blinks</div>
        </div>
        <div class="mini-stat">
          <span>‚ö°</span>
          <div class="value" id="yawns">0</div>
          <div class="label">Yawns</div>
        </div>
        <div class="mini-stat">
          <span>‚ö†</span>
          <div class="value" id="alerts">0</div>
          <div class="label">Alerts</div>
        </div>
        <div class="mini-stat">
          <span>üåô</span>
          <div class="value" id="microSleeps2">0</div>
          <div class="label">Micro-sleeps</div>
        </div>
      </div>

      <!-- Head Pose -->
      <div class="stat-card">
        <h3>Head Pose Score</h3>
        <div style="display:flex;align-items:center;gap:12px;">
          <div class="progress-bar" style="flex:1;">
            <div class="progress-fill" id="headPoseBar" style="width:0%"></div>
          </div>
          <span style="font-size:14px;font-weight:700;color:#22c55e;" id="headPoseValue">0%</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Section -->
  <div class="bottom-grid">
    <!-- Driving Modes -->
    <div class="stat-card">
      <h3>‚öô Driving Modes</h3>
      <div style="display:flex;flex-direction:column;gap:12px;margin-top:16px;">
        <div class="mode-toggle active" id="safetyMode" onclick="toggleSafety()">
          <div class="mode-icon">üõ°</div>
          <div class="mode-info">
            <p>Safety Mode</p>
            <small>Maximum sensitivity &amp; alerts</small>
          </div>
          <div class="toggle-switch active" id="safetySwitch">
            <div class="toggle-knob"></div>
          </div>
        </div>
        <div class="mode-toggle" id="ecoMode" onclick="toggleEco()">
          <div class="mode-icon">‚ö°</div>
          <div class="mode-info">
            <p>Eco Mode</p>
            <small>Reduced processing, saves battery</small>
          </div>
          <div class="toggle-switch" id="ecoSwitch">
            <div class="toggle-knob"></div>
          </div>
        </div>
      </div>
      <p style="font-size:12px;color:#888;margin-top:12px;" id="modeStatus">‚ö° Maximum protection active</p>
    </div>

    <!-- Wellness Insights -->
    <div class="stat-card">
      <h3>‚ù§ Wellness Insights</h3>
      <div class="wellness-box" style="margin-top:16px;">
        <p id="wellnessTitle">‚ú® Great Alertness!</p>
        <small id="wellnessText">Your eye openness is excellent. Keep maintaining good sleep habits.</small>
      </div>
      <div class="wellness-stats">
        <div>
          <span>üìà</span>
          <div class="val" id="sessionTime">0m 0s</div>
          <div class="lbl">Session Time</div>
        </div>
        <div>
          <span>‚ù§</span>
          <div class="val" id="avgAlertness">100%</div>
          <div class="lbl">Avg Alertness</div>
        </div>
      </div>
    </div>
  </div>

  <!-- How It Works -->
  <div class="how-section">
    <div class="glass-card" style="padding:32px;">
      <h3 style="margin-bottom:24px;font-size:18px;font-weight:700;">How It Works</h3>
      <div class="how-grid">
        <div>
          <h4 style="font-weight:600;">Eye Aspect Ratio (EAR) Formula:</h4>
          <code>EAR = (|p2-p6| + |p3-p5|) / (2 √ó |p1-p4|)</code>
          <p style="font-size:14px;color:#888;margin-top:8px;">
            When EAR drops below 0.25 for 2-3 seconds, drowsiness is detected.
          </p>
        </div>
        <div>
          <h4 style="font-weight:600;">Detection Features:</h4>
          <ul>
            <li>‚Ä¢ 68-point facial landmark detection</li>
            <li>‚Ä¢ Real-time EAR &amp; MAR calculation</li>
            <li>‚Ä¢ Micro-sleep detection</li>
            <li>‚Ä¢ Head pose monitoring</li>
            <li>‚Ä¢ Multi-factor drowsiness scoring</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="footer-grid">
      <div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
          <span style="font-size:20px;">üëÅ</span>
          <span style="font-weight:700;">Vigilance Driver</span>
        </div>
        <p style="font-size:14px;color:#888;">
          Driver drowsiness detection system using advanced facial landmark analysis
          and Eye Aspect Ratio (EAR) technology to keep drivers safe on the road.
        </p>
        <div style="margin-top:12px;font-size:12px;color:#22c55e;">
          üõ° Privacy First &nbsp;&nbsp; ‚ö° Real-time
        </div>
      </div>
      <div>
        <h4>Features</h4>
        <ul>
          <li>EAR-based Detection</li>
          <li>Micro-sleep Alerts</li>
          <li>Yawn Detection</li>
          <li>Head Pose Tracking</li>
          <li>Session Analytics</li>
        </ul>
      </div>
      <div>
        <h4>Technology</h4>
        <ul>
          <li>face-api.js</li>
          <li>68-point Landmarks</li>
          <li>Web Audio API</li>
          <li>Flask + Python</li>
          <li>Real-time Processing</li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      ¬© 2026 Vigilance Driver - Driver Drowsiness Detection System. All rights reserved.
    </div>
  </footer>

  <script>
    let isRunning = false;
    let privacyMode = false;
    let safetyActive = true;
    let ecoActive = false;
    let sessionSeconds = 0;
    let sessionInterval = null;
    let logs = [];

    function toggleDetection() {
      isRunning = !isRunning;
      const btn = document.getElementById('toggleBtn');
      if (isRunning) {
        btn.innerHTML = '‚èπ Stop Detection';
        btn.classList.add('running');
        document.getElementById('placeholder').style.display = 'none';
        startSession();
        fetch('/start_detection', { method: 'POST' });
      } else {
        btn.innerHTML = 'üì∑ Start Detection';
        btn.classList.remove('running');
        stopSession();
        fetch('/stop_detection', { method: 'POST' });
      }
    }

    function togglePrivacy() {
      privacyMode = !privacyMode;
      const btn = document.getElementById('privacyBtn');
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      if (privacyMode) {
        btn.innerHTML = 'üõ° Privacy Mode üîí';
        video.style.filter = 'blur(20px)';
        canvas.style.filter = 'blur(20px)';
      } else {
        btn.innerHTML = 'üõ° Privacy Mode üëÅ';
        video.style.filter = '';
        canvas.style.filter = '';
      }
    }

    function toggleSafety() {
      safetyActive = !safetyActive;
      if (safetyActive) ecoActive = false;
      updateModes();
    }

    function toggleEco() {
      ecoActive = !ecoActive;
      if (ecoActive) safetyActive = false;
      updateModes();
    }

    function updateModes() {
      const sm = document.getElementById('safetyMode');
      const ss = document.getElementById('safetySwitch');
      const em = document.getElementById('ecoMode');
      const es = document.getElementById('ecoSwitch');
      const ms = document.getElementById('modeStatus');

      sm.className = 'mode-toggle' + (safetyActive ? ' active' : '');
      ss.className = 'toggle-switch' + (safetyActive ? ' active' : '');
      em.className = 'mode-toggle' + (ecoActive ? ' active' : '');
      es.className = 'toggle-switch' + (ecoActive ? ' active' : '');
      ms.textContent = safetyActive ? '‚ö° Maximum protection active' : '‚ö° Eco mode active';
    }

    function startSession() {
      sessionSeconds = 0;
      sessionInterval = setInterval(() => {
        sessionSeconds++;
        const m = Math.floor(sessionSeconds / 60);
        const s = sessionSeconds % 60;
        document.getElementById('sessionTime').textContent = m + 'm ' + s + 's';
      }, 1000);
      pollData();
    }

    function stopSession() {
      clearInterval(sessionInterval);
    }

    function pollData() {
      if (!isRunning) return;
      fetch('/get_status')
        .then(r => r.json())
        .then(data => {
          updateUI(data);
          setTimeout(pollData, 500);
        })
        .catch(() => setTimeout(pollData, 1000));
    }

    function updateUI(d) {
      // EAR
      const ear = d.ear || 0;
      document.getElementById('earValue').textContent = ear.toFixed(3);
      document.getElementById('earBar').style.width = Math.min(100, (ear / 0.4) * 100) + '%';
      document.getElementById('earStatus').textContent =
        'Threshold: 0.25 | ' + (ear >= 0.25 ? 'Eyes Open' : 'Eyes Closed');

      // Drowsiness
      const ds = d.drowsiness_score || 0;
      document.getElementById('drowsinessValue').textContent = ds;
      document.getElementById('drowsinessBar').style.width = ds + '%';
      const bar = document.getElementById('drowsinessBar');
      bar.className = 'progress-fill' + (ds < 30 ? '' : ds < 60 ? ' warning' : ' danger');

      const fl = document.getElementById('fatigueLabel');
      if (ds < 30) { fl.textContent = 'Low Fatigue Level'; fl.style.color = '#22c55e'; }
      else if (ds < 60) { fl.textContent = 'Moderate Fatigue'; fl.style.color = '#f59e0b'; }
      else { fl.textContent = 'High Fatigue - Rest Now!'; fl.style.color = '#ef4444'; }

      document.getElementById('explainText').textContent =
        ds < 30 ? '‚Ä¢ Alertness levels are normal' :
        ds < 60 ? '‚Ä¢ Some fatigue indicators detected' :
        '‚Ä¢ Multiple drowsiness indicators active';

      // Status
      const banner = document.getElementById('statusBanner');
      if (ds < 30) { banner.textContent = 'Driver Alert'; banner.className = 'status-banner status-alert'; }
      else if (ds < 60) { banner.textContent = 'Caution'; banner.className = 'status-banner status-warning'; }
      else { banner.textContent = 'Drowsy - Pull Over!'; banner.className = 'status-banner status-danger'; }

      // Stats
      document.getElementById('microSleeps').textContent = d.microsleeps || 0;
      document.getElementById('microSleeps2').textContent = d.microsleeps || 0;
      document.getElementById('blinkRate').textContent = (d.blink_rate || 0) + '/min';
      document.getElementById('blinks').textContent = d.blinks || 0;
      document.getElementById('yawns').textContent = d.yawns || 0;
      document.getElementById('alerts').textContent = d.alerts || 0;
      document.getElementById('headPoseBar').style.width = (d.head_pose_score || 0) + '%';
      document.getElementById('headPoseValue').textContent = Math.round(d.head_pose_score || 0) + '%';

      // Alertness
      const alertness = Math.max(0, 100 - ds);
      document.getElementById('avgAlertness').textContent = alertness + '%';

      // Wellness
      const wt = document.getElementById('wellnessTitle');
      const wxt = document.getElementById('wellnessText');
      if (ds < 30) {
        wt.textContent = '‚ú® Great Alertness!';
        wxt.textContent = 'Your eye openness is excellent. Keep maintaining good sleep habits.';
      } else if (ds < 60) {
        wt.textContent = '‚ö†Ô∏è Stay Focused';
        wxt.textContent = 'Fatigue detected. Consider taking a break soon.';
      } else {
        wt.textContent = 'üõë Rest Required';
        wxt.textContent = 'High fatigue levels detected. Please pull over and rest.';
      }

      // Logs
      if (d.logs && d.logs.length > logs.length) {
        logs = d.logs;
        const list = document.getElementById('logList');
        list.innerHTML = '';
        logs.forEach(log => {
          const div = document.createElement('div');
          div.className = 'log-item';
          div.innerHTML = '<span class="log-time">' + log.time + '</span>' +
            '<span class="' + (log.type === 'danger' ? 'log-danger' : log.type === 'warning' ? 'log-warning' : '') + '">' +
            log.message + '</span>';
          list.appendChild(div);
        });
        document.getElementById('logCount').textContent = logs.length + ' events';
        list.scrollTop = list.scrollHeight;
      }
    }

    function signOut() {
      window.location.href = '/logout';
    }

    // Init: check models loaded
    fetch('/models_status')
      .then(r => r.json())
      .then(d => {
        if (d.loaded) {
          document.getElementById('placeholderText').textContent = 'Click Start to begin detection';
        }
      })
      .catch(() => {});
  </script>
</body>
</html>
